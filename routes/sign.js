// ---------------------------------------------------------------------------------------------- \\
var should = require('should');
// ---------------------------------------------------------------------------------------------- \\
module.exports = function (req, res, next) {
    /******************************************************************************** SMOKE-TEST **/
    // ------------------------------------------------------------------------------------------ \\
    req                               .should.be.an.Object;
    // ------------------------------------------------------------------------------------------ \\
    req.constructor.name              .should.equal('IncomingMessage');
    // ------------------------------------------------------------------------------------------ \\
    req                               .should.have.property('params')
    // ------------------------------------------------------------------------------------------ \\
    req.params                        .should.be.an.Object;
    // ------------------------------------------------------------------------------------------ \\                                  
    req.params                        .should.have.property('dir');
    // ------------------------------------------------------------------------------------------ \\
    req.params.dir                    .should.be.a.String;
    // ------------------------------------------------------------------------------------------ \\
    ['in', 'out', 'up', 'off', 'down']
                                      .should.containEql(req.params.dir);
    // ------------------------------------------------------------------------------------------ \\
    res                               .should.be.an.Object;
    // ------------------------------------------------------------------------------------------ \\
    res.constructor.name              .should.equal('ServerResponse');
    // ------------------------------------------------------------------------------------------ \\
    next                              .should.be.a.Function;
    // ------------------------------------------------------------------------------------------ \\
  /********************************************************************************   DOMAIN     **/
  // -------------------------------------------------------------------------------------------- \\
  var domain = require('domain').create();
  // -------------------------------------------------------------------------------------------- \\
  domain.on('error', function (error) {
    return next(error);
  });
  // -------------------------------------------------------------------------------------------- \\
  domain.run(function () {
    // ------------------------------------------------------------------------------------------ \\
    switch ( req.params.dir ) {
      /******************************************************************************** SIGN-UP  **/
      // ---------------------------------------------------------------------------------------- \\
      case 'up':
        // -------------------------------------------------------------------------------------- \\
          req                             .should.have.property('body');
          // ------------------------------------------------------------------------------------ \\
          req.body                        .should.be.an.Object;
          // ------------------------------------------------------------------------------------ \\
          req.body                        .should.have.property('email');
          // ------------------------------------------------------------------------------------ \\
          req.body.email                  .should.be.a.String;
          // ------------------------------------------------------------------------------------ \\
          req.body                        .should.have.property('password');
          // ------------------------------------------------------------------------------------ \\
          req.body.password               .should.be.a.String;
        // -------------------------------------------------------------------------------------- \\
        var User = require('../lib/api/users');
          // ------------------------------------------------------------------------------------ \\
          User                            .should.be.an.Object;
          User                            .should.have.property('POST');
          User.POST                       .should.be.a.Function;
        // -------------------------------------------------------------------------------------- \\
        /********************************************************************** CREATE NEW USER  **/
        // -------------------------------------------------------------------------------------- \\
        User.POST({
            body: req.body
          },
          // ------------------------------------------------------------------------------------ \\
          domain.intercept(function (saved) {
            req.session['synuser'] = {
              email: req.body.email
            };
            res.json(saved);
          }));
        // -------------------------------------------------------------------------------------- \\
        break;
      // ---------------------------------------------------------------------------------------- \\
      /******************************************************************************** SIGN-IN  **/
      // ---------------------------------------------------------------------------------------- \\
      case 'in':
        // -------------------------------------------------------------------------------------- \\
          req                             .should.have.property('body');
          // ------------------------------------------------------------------------------------ \\
          req.body                        .should.be.an.Object;
          // ------------------------------------------------------------------------------------ \\
          req.body                        .should.have.property('email');
          // ------------------------------------------------------------------------------------ \\
          req.body.email                  .should.be.a.String;
          // ------------------------------------------------------------------------------------ \\
          req.body                        .should.have.property('password');
          // ------------------------------------------------------------------------------------ \\
          req.body.password               .should.be.a.String;
        // -------------------------------------------------------------------------------------- \\
        var User = require('../lib/models/User.model');
          // ------------------------------------------------------------------------------------ \\
          User                            .should.be.a.Function;
          User                            .should.have.property('findOne');
          User.findOne                    .should.be.a.Function;
        // -------------------------------------------------------------------------------------- \\
        /**************************************************************************** FIND USER  **/
        // -------------------------------------------------------------------------------------- \\
        function notFound () {
          var error = new Error('No such user');
          error.status = 404;
          throw error;
        }
        User.findOne({
            email: req.body.email
          },
          // ------------------------------------------------------------------------------------ \\
          domain.intercept(function (user) {
            if ( ! user ) {
              return notFound();
            }

            var bcrypt = require('bcrypt');

            bcrypt.compare(req.body.password, user.password, domain.intercept(function (same) {
              if ( ! same ) {
                return notFound();
              }
              req.session['synuser'] = {
                email: user.email
              };
              res.json({ in: true });
            }));
          }));
        // -------------------------------------------------------------------------------------- \\
        break;
      // ---------------------------------------------------------------------------------------- \\
      case 'out':
        req.session.cookie.expires = Date.now();

        res.clearCookie('synuser');

        delete req.session;

        res.redirect('/sign/down');
        break;
      case 'down':
        return res.json({ session: req.session, cookies: req.signedCookies });
        res.redirect('/');
        break;
      // ---------------------------------------------------------------------------------------- \\
    }
    // ------------------------------------------------------------------------------------------ \\
  });
  // -------------------------------------------------------------------------------------------- \\
};