var should = require('should');
//  --------------------------------------------------------------------------------------------  //
/** **********************************************************************************  GET()    **/
//  --------------------------------------------------------------------------------------------  //
exports.find = function (options, cb) {

  options = options || {};

  options               .should.be.an.Object;
  cb                    .should.be.a.Function;

  var domain = require('domain').create();

  domain.on('error', function (error) {
    cb(error);
  });

  domain.run(function () {
    var User = require('../models/User.model');

    User.find(options, 'email', domain.intercept(function (users) {
      cb(null, users);
    }));
  });
};
//  --------------------------------------------------------------------------------------------  //
/** **********************************************************************************  POST()   **/
//  --------------------------------------------------------------------------------------------  //
exports.POST = function (req, cb) {
  var bcrypt = require('bcrypt');
    // -----------------------------------------------------------------------------------------  //
    req                               .should.be.an.Object;
    // -----------------------------------------------------------------------------------------  //
    cb                                .should.be.a.Function;
  // -------------------------------------------------------------------------------------------  //
  var domain = require('domain').create();
  // -------------------------------------------------------------------------------------------  //
  domain.on('error', function (error) {
    cb(error);
  });
  // -------------------------------------------------------------------------------------------  //
  domain.run(function () {
    // -----------------------------------------------------------------------------------------  //
    var User = require('../models/User.model');
      // ---------------------------------------------------------------------------------------  //
      User                        .should.be.a.Function;
      // ---------------------------------------------------------------------------------------  //
      req.body                    .should.be.an.Object;
      // ---------------------------------------------------------------------------------------  //
      req.body                    .should.have.property('email');
      // ---------------------------------------------------------------------------------------  //
      req.body                    .should.have.property('password');
      // ---------------------------------------------------------------------------------------  //
      req.body.email              .should.be.a.String;
      // ---------------------------------------------------------------------------------------  //
      req.body.password           .should.be.a.String;
    // -----------------------------------------------------------------------------------------  //
    var user = new User({
      email: req.body.email
    });
      // ---------------------------------------------------------------------------------------  //
      user                        .should.be.an.Object;
      // ---------------------------------------------------------------------------------------  //
      user                        .should.have.property('save');
      // ---------------------------------------------------------------------------------------  //
      user.save                   .should.be.a.Function;
    // -----------------------------------------------------------------------------------------  //
    bcrypt.genSalt(10, domain.intercept(function (salt) {
      // ---------------------------------------------------------------------------------------  //
      bcrypt.hash(req.body.password, salt, domain.intercept(function (hash) {
        // -------------------------------------------------------------------------------------  //
        user.password = hash;
        // -------------------------------------------------------------------------------------  //
        user.save(domain.intercept(function (saved) {
            // ---------------------------------------------------------------------------------  //
            should(saved)                   .be.an.Object;
            // ---------------------------------------------------------------------------------  //
          cb(null, { saved: saved });
          // -----------------------------------------------------------------------------------  //
        }));
        // -------------------------------------------------------------------------------------  //
      }));
      // ---------------------------------------------------------------------------------------  //
    }))
  // -------------------------------------------------------------------------------------------  //
  });
};
