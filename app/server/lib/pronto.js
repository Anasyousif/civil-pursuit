/***

         @\_______/@
        @|XXXXXXXX |
       @ |X||    X |
      @  |X||    X |
     @   |XXXXXXXX |
    @    |X||    X |             V
   @     |X||   .X |
  @      |X||.  .X |                      V
 @      |%XXXXXXXX%||
@       |X||  . . X||
        |X||   .. X||                               @     @
        |X||  .   X||.                              ||====%
        |X|| .    X|| .                             ||    %
        |X||.     X||   .                           ||====%
       |XXXXXXXXXXXX||     .                        ||    %
       |XXXXXXXXXXXX||         .                 .  ||====% .
       |XX|        X||                .        .    ||    %  .
       |XX|        X||                   .          ||====%   .
       |XX|        X||              .          .    ||    %     .
       |XX|======= X||============================+ || .. %  ........
===== /            X||                              ||    %
                   X||           /)                 ||    %
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Nina Butorac

                                                                             
                                                                             

       $$$$$$$  $$    $$  $$$$$$$    $$$$$$    $$$$$$    $$$$$$ 
      $$        $$    $$  $$    $$        $$  $$    $$  $$    $$
       $$$$$$   $$    $$  $$    $$   $$$$$$$  $$    $$  $$    $$
            $$  $$    $$  $$    $$  $$    $$  $$    $$  $$    $$
      $$$$$$$    $$$$$$$  $$    $$   $$$$$$$  $$$$$$$   $$$$$$$ 
                      $$                      $$        $$      
                      $$                      $$        $$     
                 $$$$$$                       $$        $$      







      4UUUUUUUUUUUUUUUUUUUUU!!!UUX!!!!!!!!!!!!!!!!!!!!XUUUUUUUUUUUUUUUUUUUUUUX~
     4$$$$$$$$$$$$$$$$$$$$#~~<@$$!~~~~~~~~~~~~~~~~~~~~~9$$$$$$$$$$$$$$$$$$$$$$ 
     M$$$$$$$$$$$$$$$$$$*~~~~!$$F~~~~~~~~~~~~~~~~~~~~~~~$$$$$$$$$$$$$$$$$$$$$$>
     '$$$$$$$$$$#####!~~~~~~~!$$!~~~~~~~~~~~~~~~~~~~~~~~~~#$$$$$$$$$$$$$$$$$$$>
      4$$$$$$$#~~~~~~~~~~~~~~~9$k~~~~~~~~~~~~~~~~~~~~~~~~~~~~$$$$$$$$$$$$$$$$$k
      d$$$$$$R~~~~~~~~~~~~~~~~~R$k~~~~~~~~~~~~~~~~~~~~~~~~~~~~#$$$$$$$$$$$$$$$$
   'k4$$$$$$$R~~~~~~~~~~~~~~~~~~#ZX~~~~~~~~~~~~~~~~~~~~~~~~~~~~$$$$$$$$$$$$$$$"
    '$$$$$$$$R~~~<::::~~~~~~~~~~~~!?<~~~~~~~~~~~~~~~~~~~~~~~~~~$$$$$$$$$$$$$$  
      ^#$$$$$$~~!MMMMRR$$eii:~~~~~~~~~~~~~~~~~~~~~:iied$$$RMX~~$$$$$$$$$$$$F   
         '$$$$~~~?MM888888$$$$$i:~~~~~~~~~~u@$$$$$$BB888MMMM~~~$$$R#~$$$$$"    
          `#$$~~~~~!M$$$$$$$WBP8$k~~~~~~~~$$B@#B$$$$$$$RM*!~~~~$$~~~~$$$$      
          Jr$$~~~~~~~#L R$$$F^T$$$~~~~~~~M@RMF #$$$F.dR!~~~~~~<$!~~~$$$$       
        .@$R4$~~~~~~~~~~~~~~~~~~~~!~~~~~H~~~~~~~~~~~~~~~~~~~~~4$~~~$$$$\       
      :@$$$R~$~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~M%~~$$$$#        
    x$$$$$$$>~k~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~$~TM$$$F         
   J$$$$$$$#UP4:~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~iu$$X$$N         
  $$$$$$$PX$$$$$:~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~d$$$$B.9BL        
 4$$$$$$B $$$$$$$~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~<$$$$$$!$$R        
J$$$$$$$$X$$$$$$?B~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~<$$$$$$RW$$F        
$$$$$$$$$B?$$$$$X~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~M<7$$$?$$$$         
$$$$$$$$$$$$WWW$R~~~~~~~~~~~~~~~~$N>~~<@$!~~~~~~~~~~~~~~~~~~$$$$$$$$"          
$$$$$$$$$$$$$$$T?k~~~~~~~~~~~~~~~~~?$@!~~~~~~~~~~~~~~~~~~~~<$$$$$              
$$$$$$$$$$$$R!!!!M>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~M$$$$               
$$$$$$$$$$!!!!!!XW$:~~~~~~~~~~~X+?T?X:+TT%n:~~~~~~~~~~~~~~@$$$$                
$$$$$$$T!!!!!!W$$$$B:~~~~~~~~"M????X!!X!????#"~~~~~~~~~~~@$$$$                 
$$$$$?!!!!!!X$$$$$$$N:~~~~~~~~~t!!!!!!!!!!!!~~~~~~~~~~~X?!!#$$$$.              
$$$R!!!!!!!!$$$$$$$$$$i~~~~~~~~~!X!h::h!!X!~~~~~~~~~~:*!!!!!!#$$$N             
$T!!!!!!!!!8$$$$$$$$$$$$:~~~~~~~~~~"""""~~~~~~~~~~~:@!~E!!!!!!?$$$$c           
!!!!!!!!!!9$$$$$$$$$$$$$$$i~~~~~~~~~~~~~~~~~~~~~~:@!~~~E!!!!!!!!$$$$N          
!!!!!!!!!!$$$$$$$$$$$$$$$$$$L~~~~~~~~~~~~~~~~~~<8!~~~~4!!!!!!!!!!?$$$$L        
!!!!!!!!!M$$$$$$$$$$$$$$$$$$$$i:~~~~~~~~~~~~~:@"~~~~~~4!!!!!!!!!!!!$$$$$       
!!!!!!!!X$$$$$$$$$$$$$$$$$$$$$$$$beuuuuuuze@$F~~~~~~~~@!!!!!!!!!!!!!CHAT95  



                                                            
      _______  __    __  _______    ______    ______    ______  
     /       |/  |  /  |/       \  /      \  /      \  /      \ 
    /$$$$$$$/ $$ |  $$ |$$$$$$$  | $$$$$$  |/$$$$$$  |/$$$$$$  |
    $$      \ $$ |  $$ |$$ |  $$ | /    $$ |$$ |  $$ |$$ |  $$ |
     $$$$$$  |$$ \__$$ |$$ |  $$ |/$$$$$$$ |$$ |__$$ |$$ |__$$ |
    /     $$/ $$    $$ |$$ |  $$ |$$    $$ |$$    $$/ $$    $$/ 
    $$$$$$$/   $$$$$$$ |$$/   $$/  $$$$$$$/ $$$$$$$/  $$$$$$$/  
              /  \__$$ |                    $$ |      $$ |      
              $$    $$/                     $$ |      $$ |      
               $$$$$$/                      $$/       $$/       
                                               __               
                                              /  |              
      ______    ______    ______   _______   _$$ |_     ______  
     /      \  /      \  /      \ /       \ / $$   |   /      \ 
    /$$$$$$  |/$$$$$$  |/$$$$$$  |$$$$$$$  |$$$$$$/   /$$$$$$  |
    $$ |  $$ |$$ |  $$/ $$ |  $$ |$$ |  $$ |  $$ | __ $$ |  $$ |
    $$ |__$$ |$$ |      $$ \__$$ |$$ |  $$ |  $$ |/  |$$ \__$$ |
    $$    $$/ $$ |      $$    $$/ $$ |  $$ |  $$  $$/ $$    $$/ 
    $$$$$$$/  $$/        $$$$$$/  $$/   $$/    $$$$/   $$$$$$/  
    $$ |                                                        
    $$ |                                                        
    $$/                                                         

      _______   ______    ______   __     __  ______    ______  
     /       | /      \  /      \ /  \   /  |/      \  /      \ 
    /$$$$$$$/ /$$$$$$  |/$$$$$$  |$$  \ /$$//$$$$$$  |/$$$$$$  |
    $$      \ $$    $$ |$$ |  $$/  $$  /$$/ $$    $$ |$$ |  $$/ 
     $$$$$$  |$$$$$$$$/ $$ |        $$ $$/  $$$$$$$$/ $$ |      
    /     $$/ $$       |$$ |         $$$/   $$       |$$ |      
    $$$$$$$/   $$$$$$$/ $$/           $/     $$$$$$$/ $$/       
                                                            
                                                            
                                                            

***/

! function () {

  'use strict';

  var pronto = require('prontojs');

  var when = pronto.when;

  module.exports = function () {

    var config = require('../../business/config.json');

    var exportConfig = config.public;

    // exportConfig.user = { name: 'Roger' };

    var monson = require('monson')(process.env.MONGOHQ_URL, {
      base: require('path').join(process.cwd(), 'app/business')
    });

    var facebook = config.facebook;

    facebook.url    =   exportConfig.routes['sign in with Facebook'];
    facebook.okUrl  =   exportConfig.routes['sign in with Facebook OK'];

    facebook.associate = function (profile, tokens, done) {

      var email = profile.id + '@facebook.com';

      monson.get('models/User.findOne?email=' + email)

        .on('error', function (error) {
          done(error);
        })

        .on('success', function (user) {
          if ( ! user ) {
            monson.post('models/User')

              .on('error', function (error) {
                done(error);
              })

              .on('success', function (user) {
                done(null, user);
              });
          }
          else {
            server.emit('message', { 'facebook user found': user });
            done(null, user);
          }
        });
    };

    var server = pronto ()

      /** inject into scope */

      .inject('synapp', config)

      /** Monson custom opener */

      .opener('monson', monson.pronto)

      /** cookies */

      .cookie(config.secret)

      /** passport */

      .passport({
        serialize: function () {},
        deserialzie: function () {},
        strategies: {
          facebook: facebook
        }
      })

      /** pre router */

      .open(function prerouter (req, res, next) {
        req.user = req.signedCookies.synuser;
        next();
      }, when('/*'))

      /** /sign/in ==> Sign in */

      .open('app/server/routes/sign-in.js', { exec: 'js/middleware' }, when('/sign/in'))

      /** /sign/out ==> Sign out */

      .open('app/server/routes/sign-out.js', { exec: 'js/middleware' }, when('/sign/out'))

      /** /models ==> Monson */

      .open('app/business/models/', { with: 'monson', 'append extension': 'js' }, when('/models' ))

      /** / ==> Home page */

      .open('app/web/views/pages/index.jade', when.home)

      /** /page/ ==> Static pages */

      .open('app/web/views/pages', { 'append extension': 'jade' }, when.prefix('/page/'))

      /** /partial/ ==> Partials */

      .open('app/web/views/partials', { 'append extension': 'jade' }, when.prefix('/partial/'))

      /** /bower/ ==> Bower components */

      .open('app/web/bower_components/', when.prefix('/bower/'))

      /** /js/ ==> JS files */

      .open('app/web/dist/js',
        when.prefix('/js'))

      /** /css/ ==> CSS files */

      .open('app/web/dist/css', when.prefix('/css'))

      /** /item/ ==> Item static page */

      .open(function staticItemPage (req, res, next) {

        monson.get('models/Item.findById/' + req.params.itemid)

          .on('error', function (error) {
            next(error);
          })

          .on('success', function (item) {
            res.locals.item = item;

            if ( item.references.length ) {
              res.locals.youtube = require('../../web/js/true-story/controllers/youtube')(item.references[0].url, true);
            }

            next();
          });

      }, when('/item/:itemid/:itemslug'))

      .open('app/web/views/pages/item.jade', when('/item/*'))

      /** 404 */

      .open('app/web/views/pages/not-found.jade', when(404))

      .on('listening', function (service) {
        require('./io')(server);
      })

      .on('error', function (error) {
        console.log('erroooooooooor');
      })

      // .open ( routes.urlTitleFetcher, when.post ( '/tools/get-title' ) )

      ;

    return server;

  };

} ();
