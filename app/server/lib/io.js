/***


         @\_______/@
        @|XXXXXXXX |
       @ |X||    X |
      @  |X||    X |
     @   |XXXXXXXX |
    @    |X||    X |             V
   @     |X||   .X |
  @      |X||.  .X |                      V
 @      |%XXXXXXXX%||
@       |X||  . . X||
        |X||   .. X||                               @     @
        |X||  .   X||.                              ||====%
        |X|| .    X|| .                             ||    %
        |X||.     X||   .                           ||====%
       |XXXXXXXXXXXX||     .                        ||    %
       |XXXXXXXXXXXX||         .                 .  ||====% .
       |XX|        X||                .        .    ||    %  .
       |XX|        X||                   .          ||====%   .
       |XX|        X||              .          .    ||    %     .
       |XX|======= X||============================+ || .. %  ........
===== /            X||                              ||    %
                   X||           /)                 ||    %
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Nina Butorac

                                                                             
                                                                             

       $$$$$$$  $$    $$  $$$$$$$    $$$$$$    $$$$$$    $$$$$$ 
      $$        $$    $$  $$    $$        $$  $$    $$  $$    $$
       $$$$$$   $$    $$  $$    $$   $$$$$$$  $$    $$  $$    $$
            $$  $$    $$  $$    $$  $$    $$  $$    $$  $$    $$
      $$$$$$$    $$$$$$$  $$    $$   $$$$$$$  $$$$$$$   $$$$$$$ 
                      $$                      $$        $$      
                $$    $$                      $$        $$     
                 $$$$$$                       $$        $$      $$$$$$                



▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓
▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓
▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓
▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓████████████████████▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓
▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█████████████████████████████▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓
▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█████████████████████████████████▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓
▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓████████████████████████████████████▓▓▓▓▓▓▓▒▒▒▒▓▓▓
▓▓▓▓▓▒▒▒▒▓▓▓▓▓▓▓▓▓███████████████████████████████████████▓▓▓▓▓▒░░░▒▓▓▒
▓▓▓▒▒░░▒▒▓▓▓▒▒▒▒▓████████████████████▓▓▓██████████████████▓▓▓▒▒░░░▒▒▒░
▓▓▓▒░░░▒▒▒▒▒░▒▓███████████████████▓▓▓▓▒▓▓▓▓████████████████▓▓▓▒░░░░▒▒░
▓▓▓▒░░░░▒░░░░▒███████████████▓▓▓▓▓▒▒▒▒▒▒▒▒▓▓▓▓██████████████▓▓▓▒▒▒▒▒▒░
▓▓▓▓▒▒░▒▒░░▒▒▓████████████▒▒▒▒░░░░░░░░░▒░▒▒▓▓▓▓█████████████▓▒▒▒▒▒▒▒▒▒
▓▓▓▓▒▒▒▒▒░▒▒▓▓▓████▓▓▓▓▓▒▒░░▒▒░░░░░░░░░░░░▒▒▓▓▓▓▓████████████▓▓▒▒▒▒▒▒▒
▓▓▓▒▒▒▒▒▒▒▒▒▒▒▒███▓▓▒▒▒░░▒░▒▒▒▒▒▒▒▒▒░░░░░▒░▒▓▓▓▓▓▓▓██████████▓▓▓▓▓▓▓▓▓
▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▒▒▒▒▒▒▒▒▒▒▒░░░░░░░▒░░░▒▒▒▒▒▒▓▓▓▒▓▓▓▓█████▓█▓▓▓▓▓▓▓▓▓
▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒▓█▓▒▒▒▒▒▒▒▒▒▒▒▒░░░░░░░░░▒▒▒▒▒░░▒▒▓▓▓▓▓▓▓█▓▒▒▓▓▓▓▓▓▓▓▓▓▓
▓▓▓▓▓▓▓▓▓▓▓▓▓▒▒▒█▓▒▒▒▒░░▒▒▓▓▓███▓▒▒▒▒░░░▒▒▒▒▒▒▒▒▓▓▓▓▓▓▓▒▒▓▒▒█▓▒▓▓▓▓▓▓▓
▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒▒█▓▒▓▓▓▒▒▒▒▓▒▒▓▓███▓▓▓▓▓▓▒▒▒▒▒▒▒▒▒▓▓▓▓▒░▒▒░░░░▓▒▓▓▓▓▓▓▓
▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓▓▒▒▒▒▒▓▓▓▒▒▒▒▒▒▓▓▓▓▒▒▒▒▒▒▒▒▓▓▓▒▒▒▒▓▓▒▒░▒▒▓▓▓▓▓▓▓
▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓████▓▓▓▓▓▒▒▓██▓▓▓▓▓▓▓▓▒▒▒▒▒▒▒▒▒▒▒▒▓▒▒▒▒▒▓▓▓▓▒░▒▓▓▓▓▓▓▓
▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▒▒▓▓██▒░▒▓▓██▓▓▓▓▓▓▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒░░▒░░░▒░▒▓▓▓▓▓▓▓
▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█▓▓▓██▓▓█▓░░░░▒▓▓▓▓▓▒░▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒░░▒▓░░░░▒▓▓▓▓▓▓▓
▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓▓▓▓▒░░░░░░░▒▒▒▒░░░░░░░▒░▒▒▒▒▒▒▒▒▒▒▒▒░░░░▓▓▓▓▓▓▓▓
▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒▒▒░░░░░░▒▒▒▒░░░░░░░░░▒▒▒▒▒▒▒▒▒▒▒░░░░░▓█▓▓▓▓▓▓▓
▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒░░▒▒▒░░░▒▒░░▒▒▓▓▓▒▒░░░▒░░▒▒▒▒▒▒▒▒▒▒▒▒▒▒▓█▓▓▓▓▓▓▓▓▒
▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒▒▒▒▒▒▒▒▒▒░░░░░░░▒▒░▒▒▓▓▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒████▓▒▒▒▒▒▒▒▒░
▓▓▓▓▓▓▒▒▒▒▒▒▒▒▒░░▒▓▒▒▒▒▓▓▒▒▒▓███▓▒░▒▒▒▓▓▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▓▓▓█▒░░▒▒▒▒▒▒░
▒▒▒▒▒▒▒▒▒▒░░░▒░░░▓▓▒▓▓▒▓█████▓▒▒░░▒▒▒▒▒▓▓▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▓▓▓░░▒▒▓▒▒▒░░
▒▒▒▒▒▒▒▒▒░▒▒▒▒░░▒▒▓▓▓▓▓▓▓▓▓▒▒▒▒▒▓▓▓███▓▓▓▓▒▒▒▒▒▒▒▒▒▒▒▒▒▒▓▓█▒░░▒▒▓▒▒░▒▒
▒░░▒▓▓▒▒░░░▒▒▒░▒▒▒▒▓▓██▓▓▓▓▓▓█▓▓▒░░░▒▓██▓▓▒▒▒▒▒▒▒▒▒▒▒▒▒▒▓▓▓▒▒▒▒▒▒▒▒▒▒▒
▒░▒▒▒▓▒▒░▒▒▒▓▒▒▒▓▓▒▒▓▓█████░░░░░▒▓█████▓▒▒▒▒▒▒▒▒▓▓▓▒▒▒▒▓▓▓▓▒░░░░░░░░░░
▒▒▒▒▒▒▒▒░▒▒▒▒▒░▒▒▒░░▒▓▓▓▓██▓▓██████▒▒▓▓▒░▒▒▒▒▒▒▓▓▓▓▓▒▓▓▓▓▓▓▒▒▒▒▒▒▒▒▒▒░
▒░▒░░░░░░░░░░░░░░░░░░▒▓▒▒▒▓████▒▒░▒░▒▒▒░▒▒▒▒▒▓▓▓▓▓▓▒▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒
▓▒▒▓▒▒▒▒▒▒▒▒▒▒░░░░░░░▒▒▓▒▒▒▓▓▓▒▒▓▓▒▒▒░░░▒▒▒▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒▓▓▓▒▒▓▓▒▓▒▒
▓▓▓▓▓▓▓▓▓▓▒▒▒▒▒▒▒▒▓▓▓▓▓▓▓▒▒▓▓▒▓▒▒▒▒▒▒░░░░░▓▓▓▓▒▒▒▓▓▓▓▓▓▓▓▓▒▓▓▒▒▒▒▒▒▒▒▒
▓▒▒▒▒▒▒▒▒▒▒▒▒▒▓▓▓▓▓▓▓▓▓▓▓▓▒▒▓▓▒▒▒▒░░░░░░░▓▓▓▓▓▒▓▓▓▓▓▓▓▓▒▓▓▒▓▓▓▓▓▓▓▓▓▓▓
▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒▒▒▒▒▒▒░░░░░▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒▒▓▓▒▒▓▓█▓▓▓▓▓▓▓
▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒▒▒▒▒▒▒▒▒▓▓██▓▓▓▓▓▓▓▓▓▓▓▒▒▒▒▓▓▒▒▓▒▓█▓▓▓▓▓▓
▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█████▓▓▓▓▓▓▓▓▓▓▒▒▒▒▒▓▓▓▒▒▓▒▒▓█▓▓▓▓
▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓████████████▓▓▓▓▓▓▓▓▒▒▒▒▒▒▓▓▓▒▒▓█░░▓▓█▓▓
▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒▒▓█████▓▓▓▓▓█▓▓▓▓▒▓▒▒▒▒▒▒▒▓▓▓▒▒▒█▒░▒▒▓██
▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒▒▒▓▓█████▓█▓█▓▓▒▒▒▒▒▒▒▒▒▒▒▒▓▓▓▒▒▒▓▒░▒▒▒▒▓
▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒▒▒▒▒▓██▓█████▓▓▓▓▒▒▒▒▒▒▒▒▒▒▒▓▓▓▒▒▓▓▒░▒▒▒▒░
▓▓▓▓▓▓▓▓▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒▒▒░▒▒▒▒▒▒▒▓▓▓▓▓▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▓▓░░▒░░▒░






                               __                    __     ______   ______  
                              /  |                  /  |   /      | /      \ 
  _______   ______    _______ $$ |   __   ______   _$$ |_  $$$$$$/ /$$$$$$  |
 /       | /      \  /       |$$ |  /  | /      \ / $$   |   $$ |  $$ |  $$ |
/$$$$$$$/ /$$$$$$  |/$$$$$$$/ $$ |_/$$/ /$$$$$$  |$$$$$$/    $$ |  $$ |  $$ |
$$      \ $$ |  $$ |$$ |      $$   $$<  $$    $$ |  $$ | __  $$ |  $$ |  $$ |
 $$$$$$  |$$ \__$$ |$$ \_____ $$$$$$  \ $$$$$$$$/   $$ |/  |_$$ |_ $$ \__$$ |
/     $$/ $$    $$/ $$       |$$ | $$  |$$       |  $$  $$// $$   |$$    $$/ 
$$$$$$$/   $$$$$$/   $$$$$$$/ $$/   $$/  $$$$$$$/    $$$$/ $$$$$$/  $$$$$$/  
                                                                             
                                                                             
                                                                             



***/

! function () {

  'use strict';

  var online_users = 0;

  var domain;

  /***
    .                           
    .                                                 
    .                                                   
    .                    $$$$$$                 $$$  $$$    
    .                   $$    $$               $$      $$   
    .$$$$$$$   $$$$$$   $$       $$$$$$       $$        $$  
    $$              $$  $$$$    $$    $$      $$        $$  
    .$$$$$$    $$$$$$$  $$      $$$$$$$$      $$        $$  
    .     $$  $$    $$  $$      $$             $$      $$   
    $$$$$$$    $$$$$$$  $$       $$$$$$$        $$$  $$$    
                                                        


                                        
  ***/


  function safe (socket, action) {
    var socket_domain = require('domain').create();

    socket_domain.on('error', function (error) {

      domain.run(function () {
        throw error;
      });
    });

    socket_domain.add(socket);

    process.nextTick(function () {
      socket_domain.run(action);
    });
  };


  function onEvent (event, args) {
    this.emit('message', {
      'socket server': {
        'new incoming request': {
          'event':      event,
          'message':    args
        }
      }
    });
  }

  function WebSocketServer (pronto) {

    'use strict';

    onEvent = onEvent.bind(pronto);

    var error_to_json = require('../../business/utils/error-to-json');

    domain = require('domain').create();

    /***
      .
      .               
      .                           
      . $$                          
      . $$                          
      $$$$$$     $$$$$$    $$$$$$   
      . $$      $$    $$  $$    $$  
      . $$      $$    $$  $$    $$  
      . $$  $$  $$    $$  $$    $$  
      .  $$$$    $$$$$$   $$$$$$$   
      .                   $$        
      .                   $$        
                          $$        

            $$
            $$
            $$                                                  
       $$$$$$$   $$$$$$   $$$$$$ $$$$    $$$$$$   $$  $$$$$$$   
      $$    $$  $$    $$  $$   $$   $$        $$  $$  $$    $$  
      $$    $$  $$    $$  $$   $$   $$   $$$$$$$  $$  $$    $$  
      $$    $$  $$    $$  $$   $$   $$  $$    $$  $$  $$    $$  
       $$$$$$$   $$$$$$   $$   $$   $$   $$$$$$$  $$  $$    $$  
                                                                
                                                        
                                                        
                                                        
                                                        
       $$$$$$    $$$$$$    $$$$$$    $$$$$$    $$$$$$   
      $$    $$  $$    $$  $$    $$  $$    $$  $$    $$  
      $$$$$$$$  $$        $$        $$    $$  $$        
      $$        $$        $$        $$    $$  $$        
       $$$$$$$  $$        $$         $$$$$$   $$        
                                                        
                                                        

                                        

    ***/



    domain.on('error', function (error) {
      pronto.emit('message', {
        'socket error': {
          message: error.message
        }
      });
      pronto.emit('error', error);
    });

    /***


                                            
                                    $$      
                                    $$      
    $$$$$$$    $$$$$$   $$    $$  $$$$$$    
    $$    $$  $$    $$   $$  $$<    $$      
    $$    $$  $$$$$$$$    $$$$      $$      
    $$    $$  $$         $$  $$     $$  $$  
    $$    $$   $$$$$$$  $$    $$     $$$$   
                                            
                                            
                                      
                                      
      $$      $$            $$        
      $$                    $$        
    $$$$$$    $$   $$$$$$$  $$    $$  
      $$      $$  $$        $$   $$<  
      $$      $$  $$        $$$$$$    
      $$  $$  $$  $$        $$   $$   
       $$$$   $$   $$$$$$$  $$    $$  
                                      
                                      
                                  

    **/

    process.nextTick(function () {

      var socketIO  =   require('socket.io');
      var io        =   socketIO(pronto.server);


      /***

                                                                
                                                                        
                                                                        
                                                                        
        $$$$$$ $$$$    $$$$$$   $$$$$$$    $$$$$$$   $$$$$$   $$$$$$$   
        $$   $$   $$  $$    $$  $$    $$  $$        $$    $$  $$    $$  
        $$   $$   $$  $$    $$  $$    $$   $$$$$$   $$    $$  $$    $$  
        $$   $$   $$  $$    $$  $$    $$        $$  $$    $$  $$    $$  
        $$   $$   $$   $$$$$$   $$    $$  $$$$$$$    $$$$$$   $$    $$  
                                                                        
             


                                                                        
        ***/

      var monson    =   require('monson')(process.env.MONGOHQ_URL, {
        base: require('path').join(process.cwd(), 'app/business')
      });

      pronto.emit('socketIO listening');
      pronto.emit('message', 'socketIO listening');

      /***

                    
                    
                          
                          
       $$$$$$   $$$$$$$   
      $$    $$  $$    $$  
      $$    $$  $$    $$  
      $$    $$  $$    $$  
       $$$$$$   $$    $$  
                          
                          
                                                                  
                                                                  
                                                                  
                                                                  
       $$$$$$$   $$$$$$   $$$$$$$   $$$$$$$    $$$$$$    $$$$$$$  
      $$        $$    $$  $$    $$  $$    $$  $$    $$  $$        
      $$        $$    $$  $$    $$  $$    $$  $$$$$$$$  $$        
      $$        $$    $$  $$    $$  $$    $$  $$        $$        
       $$$$$$$   $$$$$$   $$    $$  $$    $$   $$$$$$$   $$$$$$$  
                                                                  
                                                                  

                                                
                                                
                $$      $$                      
                $$                              
              $$$$$$    $$   $$$$$$   $$$$$$$   
      $$$$$$    $$      $$  $$    $$  $$    $$  
                $$      $$  $$    $$  $$    $$  
                $$  $$  $$  $$    $$  $$    $$  
                 $$$$   $$   $$$$$$   $$    $$  
                                                
                                                
                                          

      ***/

      io.on('connection', function (socket) {


        /***

                    
                      
                            
                            
         $$$$$$   $$$$$$$   
        $$    $$  $$    $$  
        $$    $$  $$    $$  
        $$    $$  $$    $$  
         $$$$$$   $$    $$  
                                    
                                                                    
                                                                    
                                      $$                    $$      
                                      $$                    $$      
         $$$$$$$   $$$$$$    $$$$$$$  $$    $$   $$$$$$   $$$$$$    
        $$        $$    $$  $$        $$   $$<  $$    $$    $$      
         $$$$$$   $$    $$  $$        $$$$$$    $$$$$$$$    $$      
              $$  $$    $$  $$        $$   $$   $$          $$  $$  
        $$$$$$$    $$$$$$    $$$$$$$  $$    $$   $$$$$$$     $$$$   
                                                                    
                                                                                                            
                                                          
                                                          
         $$$$$$    $$$$$$    $$$$$$    $$$$$$    $$$$$$   
        $$    $$  $$    $$  $$    $$  $$    $$  $$    $$  
        $$$$$$$$  $$        $$        $$    $$  $$        
        $$        $$        $$        $$    $$  $$        
         $$$$$$$  $$        $$         $$$$$$   $$        
                                                          
                                                          
                                                          
                                                  
                                                  
                                            

        ***/



        socket.on('error', function (error) {

          console.log('   SOCKET ERROR    '.bgYellow.cyan.bold)

          var error_json = error_to_json(error);

          pronto.emit('message', { 'socket error': error_json });
          
          pronto.emit('error', error);

          socket.emit('error', error);

        });

        /***

                                                        
                                                        
                            $$  $$                      
                            $$                          
         $$$$$$   $$$$$$$   $$  $$  $$$$$$$    $$$$$$   
        $$    $$  $$    $$  $$  $$  $$    $$  $$    $$  
        $$    $$  $$    $$  $$  $$  $$    $$  $$$$$$$$  
        $$    $$  $$    $$  $$  $$  $$    $$  $$        
         $$$$$$   $$    $$  $$  $$  $$    $$   $$$$$$$  
                                                        
                                                        
                                                          
                                                          
                                                          
        $$    $$   $$$$$$$   $$$$$$    $$$$$$    $$$$$$$  
        $$    $$  $$        $$    $$  $$    $$  $$        
        $$    $$   $$$$$$   $$$$$$$$  $$         $$$$$$   
        $$    $$        $$  $$        $$              $$  
         $$$$$$   $$$$$$$    $$$$$$$  $$        $$$$$$$   
                                                          
                                                          
                                                             
                                                  
                                                  
                                            

        ***/

        pronto.emit('message', {
          'web socket server': 'new incoming client'
        });

        /** Increment number of online  users */

        online_users ++;

        /** Let clients know about new user count */

        io.emit('online users', online_users);
        socket.broadcast.emit('online users', online_users);

        /***

                    
                      
                            
                            
           $$$$$$   $$$$$$$   
          $$    $$  $$    $$  
          $$    $$  $$    $$  
          $$    $$  $$    $$  
           $$$$$$   $$    $$  
                              
                              
                                                                
                                                                
                $$  $$                                          
                $$                                              
           $$$$$$$  $$   $$$$$$$   $$$$$$$   $$$$$$   $$$$$$$   
          $$    $$  $$  $$        $$        $$    $$  $$    $$  
          $$    $$  $$   $$$$$$   $$        $$    $$  $$    $$  
          $$    $$  $$        $$  $$        $$    $$  $$    $$  
           $$$$$$$  $$  $$$$$$$    $$$$$$$   $$$$$$   $$    $$  
                                                                
                                                                
                                                          
                                                  $$      
                                                  $$      
                  $$$$$$$    $$$$$$    $$$$$$$  $$$$$$    
          $$$$$$  $$    $$  $$    $$  $$          $$      
                  $$    $$  $$$$$$$$  $$          $$      
                  $$    $$  $$        $$          $$  $$  
                  $$    $$   $$$$$$$   $$$$$$$     $$$$   
                                                          
                                                          
                                                                            
                                                  
                                                  
                                            

        ***/

        socket.on('disconnect', function (why) {
          online_users --;
        });

        /***

                    
                      
                            
                              
           $$$$$$   $$$$$$$   
          $$    $$  $$    $$  
          $$    $$  $$    $$  
          $$    $$  $$    $$  
           $$$$$$   $$    $$  
                              
                                        
                                        
                                $$      
                                $$      
           $$$$$$    $$$$$$   $$$$$$    
          $$    $$  $$    $$    $$      
          $$    $$  $$$$$$$$    $$      
          $$    $$  $$          $$  $$  
           $$$$$$$   $$$$$$$     $$$$   
                $$                      
          $$    $$                      
           $$$$$$                       


                                                      
          $$              $$                          
                          $$                          
          $$  $$$$$$$   $$$$$$     $$$$$$    $$$$$$   
          $$  $$    $$    $$      $$    $$  $$    $$  
          $$  $$    $$    $$      $$        $$    $$  
          $$  $$    $$    $$  $$  $$        $$    $$  
          $$  $$    $$     $$$$   $$         $$$$$$   
                                                      
                                                      
                                                               
                                                  
                                                  
                                            

        ***/

        socket.on('get intro', function () {
          onEvent('get intro', arguments);
        });

        socket.on('get intro', function () {

          safe(socket, function () {
            
            monson.get('models/Item.findOne?type=Intro')

              .on('error', function (error) {
                console.log('socket get intro MONSON error');
                throw error;
              })

              .on('success', function (intro) {
                // pronto.emit('message', {
                //   'socket got intro we from monson': intro
                // });

                socket.emit('got intro', intro);

                console.log('socket get intro MONSON success');
              });
            });
        });

        /***

                    
                      
                            
                            
          .$$$$$$   $$$$$$$   
          $$    $$  $$    $$  
          $$    $$  $$    $$  
          $$    $$  $$    $$  
           $$$$$$   $$    $$  
                              
                                                            
                                                            
                                $$      
                                $$      
          .$$$$$$    $$$$$$   $$$$$$    
          $$    $$  $$    $$    $$      
          $$    $$  $$$$$$$$    $$      
          $$    $$  $$          $$  $$  
          .$$$$$$$   $$$$$$$     $$$$   
          .     $$                      
          $$    $$                      
          .$$$$$$       
                                                                                                            

                                                          
                                                          
          $$    $$                                        
                $$                                        
          $$  $$$$$$     $$$$$$   $$$$$$ $$$$    $$$$$$$  
          $$    $$      $$    $$  $$   $$   $$  $$        
          $$    $$      $$$$$$$$  $$   $$   $$   $$$$$$   
          $$    $$  $$  $$        $$   $$   $$        $$  
          $$     $$$$    $$$$$$$  $$   $$   $$  $$$$$$$   
                                                          
                                                        

                                                  
                                            

        ***/

        socket.on('get items', function () {
          onEvent('get items', arguments);
        });

        socket.on('get items', function (panel) {

          safe(socket, function () {

            if ( ! panel || typeof panel !== 'object' ) {
              throw new Error('Missing panel');
            }

            var url = 'models/Item?type=' + panel.type;

            if ( panel.parent ) {
              url += '&parent=' + panel.parent;
            }

            url += '&' + panel.size + '&$skip=' + panel.skip + '&sort:promotions-,views-,created+';

            /** Send request to monson */

            monson.get(url)
              .on('error', function (error) {
                throw error;
              })
              .on('success', function (items) {
                pronto.emit('message', 'socket got items from monson');
                socket.emit('got items', {
                  panel: panel,
                  items: items
                });
              });

          });

        });



        /***












        ***/

        socket.on('get evaluation', function () {
          onEvent('get evaluation', arguments);
        });

        socket.on('get evaluation', function (item) {
          safe(socket, function () {

            var url = 'models/Item.evaluate/' + item._id;

            monson.get(url)

              .on('error', function (error) {
                throw error;
              })

              .on('success', function (evaluation) {
                pronto.emit('message', 'socket got evaluation from monson');
                socket.emit('got evaluation', evaluation);
              });

          });
        });




        socket.on('sign in', function () {
          onEvent('sign in', arguments);
        });

        socket.on('sign in', function (credentials) {
          safe(socket, function () {
            var url = 'models/User.identify/' + credentials.email +
              '/' + credentials.password;

            monson.get(url)

              .on('error', function (error) {
                if ( /^User not found/.test(error.message) ) {
                  socket.emit('user not found', credentials);
                }
                else {
                  throw error;
                }
              })

              .on('success', function (user) {
                pronto.emit('message', 'socket got identification from monson');
                socket.emit('identified', user);
              });
          });
        });




      });

      io.on('error', function (error) {
        pronto.emit('error', error);
      });
    });
  }

  module.exports = WebSocketServer;

}();
