<!doctype html>
  
  <style>
    .panel {
      border: 5px dotted #999;
      padding: 10px 0 10px 10px;
    }
    .panel .panel {
      margin: 10px 0 10px 10px;
    }
    .item {
      border: 4px solid black;
    }
    .item-contents {
      border: 4px solid blue;
      height: 160px;
    }
    .item-nav {
      float: right;
    }
    .item-details, .item-evaluation {
      background: #ccc;
    }
  </style>

  <section role="main"></section>
      
  <script src="/bower/jquery/dist/jquery.min.js"></script>

  <script type="text/html" id="tpl-panel" src="/foo/panel.html"></script>

  <script type="text/html" id="tpl-item" src="/foo/item.html"></script>
  
  <script type="text/html" id="tpl-evaluator" src="/foo/evaluator.html"></script>

  <script type="text/html" id="tpl-details" src="/foo/details.html"></script>
  
  <!-- script src="/foo/watchable.js"></script -->
  
  <script>

    function loadTemplates (done) {
      //A list of promises that need to resolve before starting
      var loaded = [];
       
      //Load all templates
      var $templates = $('script[type="text/html"]');
      $templates.each(function() {
          var src = $(this).attr("src");
          if (src) {
              loaded.push( //Wait for the template to load
                  $.ajax(src, {context:this}).
                  done(function(data) {
                      $(this).html(data);
                  })
              );
          }
      });
       
      //Wait for the DOM to be ready
      loaded.push($.ready);
       
      //Initialise after everything is loaded
      $.when.apply($,loaded).done(done);
    }

    //////////////////////////////////////////////

    function $watch (object) {

      var self = this;

      for ( var prop in object ) {
        this[prop] = object[prop];
      }

      this.__watchers = {};

      Object.observe(this, function (changes) {
        changes.forEach(function (change) {
          if ( self.__watchers[change.name] ) {
            self.__watchers[change.name].forEach(function (watcher) {
              watcher(self[change.name]);
            });
          }
        });
      });
    }

    $watch.prototype.$watch = function(prop, watcher) {
      if ( ! this.__watchers[prop] ) {
        this.__watchers[prop] = [];
      }
      this.__watchers[prop].push(watcher);
    };

    //////////////////////////////////////////////

    var model = new $watch({
      rel: {
        Topic: ['Problem'],
        Problem: [['Agree', 'Disagree'], 'Solution'],
        Solution: [['Pro', 'Con']]
      },
      items: [],
      panels: [],
      limit: 6
    });

    /** @return jQuery .panel */
    function PanelView (options, once) {

      var panel = $($('#tpl-panel').html());

      panel.data('type', options.type);
      panel.data('parent', options.parent);
      panel.data('skip', 0);

      panel.find('h4').text(options.type);

      panel.find('.load-more-items a').on('click', function () {
        var elem = $(this), panel = elem.closest('.panel');

        console.log(panel.data('skip'))

        Ctrl.find(options.type, options.parent, panel.data('skip'))
          .success(function (items) {
            var skip = +panel.data('skip');
            skip += items.length;
            panel.data('skip', skip);
          });
        return false;
      });;

      if ( ! once ) {
        model.$watch('items', function (items) {
          ItemView(items, panel);
        });
      }

      model.panels = model.panels.concat([panel]);

      return panel;
    }

    /** Mapper */
    function ItemView (items, panel) {

      var type = panel.data('type');
      var parent = panel.data('parent');

      var iterations = [];

      items

        .filter(function (item) {
          return item.type === type;
        })

        .filter(function (item) {
          if ( parent ) {
            return item.parent === parent;
          }
          return true;
        })

        .forEach(function (item) {

          iterations.push(function () {
            var article = $('#item-' + item._id),
              isNew = false;

            if ( ! article.length ) {

              isNew = true

              article = $($('#tpl-item').html());

              article.attr('id', 'item-' + item._id);
            }

            setTimeout(function () {
              article.find('.item-subject').text(item.subject);
              article.find('.item-description').text(item.description);
            }, 250);

            // IS NEW

            if ( isNew ) {

              // Append panel to DOM

              panel.find('.items:first').append(article);

              // Evaluator

              article.find('.toggle-promote').on('click', function () {
                article.find('.item-evaluation').append(EvaluationView(item._id));
              });

              // Details

              article.find('.item-details').append(DetailsView(item._id));

              // Sub panel

              model.rel[type].forEach(function (t) {

                if ( typeof t === 'string' ) {
                  var panel = PanelView({ type: t, parent: item._id });

                  article.find('.item-panels:first').append(panel, false);
                }

                if ( Array.isArray(t) ) {
                  var div = $('<div class="row"></div>');
                  t.forEach(function (t) {
                    var panel = PanelView({ type: t, parent: item._id });
                    div.append(panel);
                  });
                  article.find('.item-panels:first').append(div, false);
                }
              });
            }
          });
        });
    
      var iteration = 1;

      function execIterations () {
        setTimeout(function () {
          iterations[iteration]();

          iteration ++;

          if ( iterations[iteration] ) {
            execIterations();
          }

        }, 750)
      }

      if ( iterations[iteration] ) {
        iterations[iteration]();

        iteration ++;

        if ( iterations[iteration] ) {
           execIterations();
        }
      }
    };

    /** Evaluator 
     *  @return jQuery .evaluator
     */

    function EvaluationView () {
      var evaluator = $($('#tpl-evaluator').html());

      return evaluator;
    }

    /** Details 
     *  @return jQuery .details
     */

    function DetailsView () {
      var details = $($('#tpl-details').html());

      return details;
    }

    var Item = {
      find: function (query, paging) {

        var params = [];

        for ( var field in query ) {
          params.push(field + (query[field] && '=' + query[field]));
        }

        if ( paging.limit ) {
          params.push(paging.limit);
        }

        if ( paging.skip ) {
          params.push('$skip=' + paging.skip);
        }

        if ( paging.sort ) {
          var sort = [];

          for ( var sorter in paging.sort ) {
            sort.push(sorter + (paging.sort > 0 ? '+' : '-'));
          }

          params.push('sort:' + sort.join(','));
        }

        return $.ajax('/models/Item?' + params.join('&'));
      }
    };

    var Ctrl = {
      find: function (type, parent, skip) {

        var query = { type: type };

        if ( parent ) {
          query.parent = parent;
        }

        return Item.find(query, {
          limit: model.limit,
          skip: skip,
          sort: {
            promotions: -1,
            views: -1
          }
        })
          .done(function (items) {
            model.items = model.items.concat(items);
          });
      }
    };

    //////////////////////////////////////////////

    loadTemplates(function () {
      $('[role=main]').append(PanelView({ type: 'Topic' }));
    });

  </script>