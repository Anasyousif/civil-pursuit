<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: models/Item.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: models/Item.js</h1>

    


    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * The Item Model
 * 
 * @class ItemSchema
 * @author francoisrvespa@gmail.com
*/

var config = require('../config/config.json');

var path = require('path');

var mongoose = require('mongoose');

var Schema = mongoose.Schema;

var User    = require('./User');

var ItemSchema = new Schema({

  
  
  "image": {
    "type": String
  },

  

  "references": [
    {
      "url": String,
      "title": String
    }
  ],

  
  
  "subject": {
    "type": String,
    "required": true
  },

  
  
  "description": {
    "type": String,
    "required": true
  },

  

  "type": {
    "type": String,
    "required": true,
    "validate": function (type) {
      return ['Topic', 'Problem', 'Solution', 'Opinion'].indexOf(type) > -1;
    }
  },

  
  
  "parent": {
    "type": Schema.Types.ObjectId,
    "ref": "Item",
    "index": true
  },

  // the user id (reference to User, required)
  
  "user": {
    "type": Schema.Types.ObjectId,
    "ref": "User",
    "required": true,
    "index": true
  },

  // The number of times Item has been promoted

  "promotions": {
    "type": Number,
    "index": true
  },

  // The number of times Item has been viewed

  "views":  {
    "type": Number,
    "index": true
  },

  // When Item was created

  "created": {
    "type": Date
  },

  // When Item was last edited

  "edited": {
    "type": Date,
    "default": Date.now
  }
});

// PRE INIT
// ========

ItemSchema.post( 'init', function() {
  this._original = this.toObject();
});

// PRE VALIDATE
// ============

ItemSchema.pre('validate', function (next) {
/*  if ( this.isNew &amp;&amp; this.parent ) {
    this.parent = Schema.Types.ObjectId(this.parent);
  }*/
  return next();
});

// PRE SAVE
// ========

ItemSchema.pre('save', function (next) {

  var self = this;

  // If creating, set default values

  if ( this.isNew ) {
    this.promotions   = 0;
    this.views        = 0;
    this.created      = Date.now();
  }

  // If image declared (and in case of editing - if image changed)

  if ( this.image &amp;&amp; ( this.isNew ? true : ( this.image !== this._original.image ) )  ) {
    
    var cloudinary = require('cloudinary');
    
    cloudinary.config({ 
      cloud_name      :   config.cloudinary.cloud.name, 
      api_key         :   config.cloudinary.API.key, 
      api_secret      :   config.cloudinary.API.secret 
    });

    return cloudinary.uploader.upload(
      
      path.join(config.tmp, this.image),
      
      function (result) {
        
        self.image = result.url;

        next();

      }      
    );
  }

  // If no image, use parent's image (if any)

  if ( this.isNew &amp;&amp; ! this.image &amp;&amp; this.parent ) {
    return Item.findById(this.parent, 'image',
      function (error, parent) {
        if ( error ) {
          return next(error);
        }

        this.image = parent.image;

        return next();
      }.bind(this));
  }

  return next();

});

/** Update Item by ID...
 *
 *  @function ItemSchema.updateById
 *  @param {String} id - The Item to update Object Id
 *  @param {Object} item - The patch
 *  @param {updateById~cb} cb - The callback
 *  @return {Object}
 */
ItemSchema.statics.updateById = function (id, item, cb) {
  var self = this;

  self.findById(id, function (error, found) {
    if ( error ) {
      return cb(error);
    }

    for ( var field in item ) {
      found[field] = item[field];
    }

    found.save(cb);
  });
};

/** Evaluate item against 5 others...
 *
 *  @method ItemSchema.evaluate
 *  @param {String} id - The Item to update Object Id
 *  @param {updateById~cb} cb - The callback
 *  @return {Object}
 */

ItemSchema.statics.evaluate = function (id, cb) {
  var self = this;

  this.findById(id, function (error, item) {
    if ( error ) {
      return cb(error);
    }

    if ( ! item ) {
      return cb(new Error('Item not found'));
    }

    require('async').parallel({
      items: function (then) {
        self
          .find({
            type: item.type,
            parent: item.parent
          })

          .where('_id').ne(item._id)

          .limit(5)

          .sort({ views: 1 })

          .exec(then);
      },
      criterias: function (then) {
        require('./Criteria').find({ type: 'Topic'}, then);
      }
    }, function (error, results) {
      cb(error, {
        type: item.type,
        item: id,
        items: results.items.concat(item),
        criterias: results.criterias
      });
    });

  });
};

/** Fetch item's related data, namely votes and feedbacks ...
 *
 *  @method ItemSchema.details
 *  @param {String} id - The Item to update Object Id
 *  @param {updateById~cb} cb - The callback
 *  @return {Object}
 */

ItemSchema.statics.details = function (id, cb) {
  var self = this;

  require('async').parallel({
      votes: function (then) {
        require('./Vote').getAccumulation(id, then);
      },

      feedbacks: function (then) {
        require('./Feedback').find({ item: id }, then);
      }
    },

    function (error, results) {
      if ( error ) {
        return cb(error);
      }

      self.findById(id, function (error, item) {
        if ( error ) {
          return cb(error);
        }

        /** Get type criterias */

        require('./Criteria')
          .find({ type: item.type }, function (error, criterias) {
            if ( error ) {
              return cb(error);
            }

            /** Return details */

            cb(null, {
              item: item,
              votes: results.votes,
              feedbacks: results.feedbacks,
              criterias: criterias
            });
          });
      });
    });
};

// EXPORT
// ======

var Item = module.exports = mongoose.model('Item', ItemSchema);
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Modules</h3><ul><li><a href="details.html">controllers/details</a></li><li><a href="editor.html">controllers/editor</a></li><li><a href="evaluator.html">controllers/evaluator</a></li><li><a href="charts.html">directives/charts</a></li><li><a href="from-now.html">filters/from-now</a></li><li><a href="get-currently-evaluated.html">filters/get-currently-evaluated</a></li><li><a href="shorten.html">filters/shorten</a></li><li><a href="module-synapp.html">synapp</a></li></ul><h3>class</h3><ul><li><a href="CriteriaSchema.html">CriteriaSchema</a></li><li><a href="FeedbackSchema.html">FeedbackSchema</a></li><li><a href="ItemSchema.html">ItemSchema</a></li><li><a href="UserSchema.html">UserSchema</a></li><li><a href="VoteSchema.html">VoteSchema</a></li></ul><h3>Global</h3><ul><li><a href="global.html#controller::navigator">controller::navigator</a></li><li><a href="global.html#controller::sign">controller::sign</a></li><li><a href="global.html#controller::upload">controller::upload</a></li><li><a href="global.html#directive::get-url-title">directive::get-url-title</a></li><li><a href="global.html#directive::more-less">directive::more-less</a></li><li><a href="global.html#directive::sliders">directive::sliders</a></li><li><a href="global.html#factory::data">factory::data</a></li><li><a href="global.html#factory::user">factory::user</a></li><li><a href="global.html#filter::get-promoted-percentage">filter::get-promoted-percentage</a></li><li><a href="global.html#model::Vote::get-accumulation">model::Vote::get-accumulation</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-alpha9</a> 
    using <a href="https://github.com/allenhwkim/angularjs-google-maps/tree/master/config/jsdoc/template">custom template </a> and 
    <a href="https://raw.githubusercontent.com/allenhwkim/angularjs-google-maps/master/config/jsdoc/plugins/angular.js">custom tag @ngdoc</a>
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
<script>
  var href=window.location.href.match(/\/([^\/]+$)/)[1];
  document.querySelector("nav a[href='"+href+"']").scrollIntoView(true);
  if (window.location.hash == "")
    document.querySelector("body").scrollIntoView(true);
</script>
</body>
</html>
